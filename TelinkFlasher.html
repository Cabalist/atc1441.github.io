<!-- Copyright: Aaron Christophel / Atc1441 https://atcnetz.de -->
<html class="telFlasherClass"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Telink Flasher</title>
</head>
<body>
<script>
var firmwareArray = "";
var startTime = 0;
var blockCount = 0;
var miEnabled = 1;

var connectTrys = 0;
var allRecnnoctTrys = 5;

var bluetoothDevice;
var gattServer;
var Theservice;
var writeCharacteristic;
var ServiceMain;
var writeCharacteristicSpeed;
var nitifiyCharTemp;

function resetVariables() {
	busy = false;
	gattServer = null;
	Theservice = null;
	writeCharacteristic = null;
}
		
function handleError(error) {
	addLog(error);
	resetVariables();
	if(connectTrys < allRecnnoctTrys){
		connectTrys++;
		addLog("Reconnect "+connectTrys+" from "+ allRecnnoctTrys);
		doConnect();
	}else{
		addLog("Something went wrong, to many reconnect's");
		connectTrys=0;
	}
}

function onDisconnected() {
	addLog('Disconnected.');
}

function connect(){
	addLog("Searching for devices");
	connectTrys = 0;
		navigator.bluetooth.requestDevice({
		optionalServices: ['00010203-0405-0607-0809-0a0b0c0d1912','ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6'],
		acceptAllDevices: true
	}).then(device => {
		bluetoothDevice = device;
		bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
		doConnect();
      }).catch(handleError);
}

function miAction(){
    gattServer.getPrimaryService('ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6')
	.then(service => {
		addLog("Found Main service");
		ServiceMain = service;
		return ServiceMain.getCharacteristic('ebe0ccd8-7a0a-4b0c-8a1a-6ff2997da3a6');
    }).then(characteristic => {
		addLog("Found write characteristic Speed");
		writeCharacteristicSpeed = characteristic;		
		return ServiceMain.getCharacteristic('ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6');
		}).then(characteristic => {
			addLog('found Temp characteristic');
			nitifiyCharTemp = characteristic;
			return nitifiyCharTemp.startNotifications().then(() => {
				nitifiyCharTemp.addEventListener('characteristicvaluechanged', event => {
				var value = event.target.value;				
				var temp=(value.getUint8(1) << 8 | value.getUint8(0)) / 100;
				var hum=value.getUint8(2);
				var tempTempString = "Temp/Humi: " + temp + "Â°C " + hum + "%";
				document.getElementById("tempHumiData").innerHTML = tempTempString;
				addClog(tempTempString);
          });
        });
		}).catch(handleError);	
}
		
function doConnect(){
    addLog("Connecting to device: " + bluetoothDevice.name);
	bluetoothDevice.gatt.connect().then(server => {
    addLog("Found GATT server");
    gattServer = server;
    return gattServer.getPrimaryService('00010203-0405-0607-0809-0a0b0c0d1912');
    }).then(service => {
		addLog("Found service");
		Theservice = service;
		return Theservice.getCharacteristic('00010203-0405-0607-0809-0a0b0c0d2b12');
    }).then(characteristic => {
		addLog("Found write characteristic");
		writeCharacteristic = characteristic;
		if(miEnabled)miAction();
	}).catch(handleError);	
}

function reConnect(){
	addLog("Reconnect");
	connectTrys = 0;
	doConnect();
}

function startDFU(){
	addLog("Start DFU");
	updateBegin();
}

function sendBLEdata(data){
	addLog(data);
}

function addLog(logTXT){
	var time = new Date().toLocaleTimeString("de-DE");
	var logString = time + ": " + logTXT;
	document.getElementById("log").innerHTML += logString + "<br>";
}

function addClog(logTXT){
	console.log(logTXT);
}

function clearLog(){
	document.getElementById("log").innerHTML = "Log:<br>";
}

function setStatus(status){
	addClog("Status: " + status);
	document.getElementById("percent").innerHTML = "Status: " + status;
}

function updateFail(err){
	addLog("Update error: " + err);
	setStatus("Update error: " + err);
}

function decimalToHex(d, padding) {
    var hex = Number(d).toString(16);
    while (hex.length < 4){
        hex = "0" + hex;
    }
    return hex;
}

function hexToBytes(hex) {
    for (var bytes = [], c = 0; c < hex.length; c += 2)
    bytes.push(parseInt(hex.substr(c, 2), 16));
    return bytes;
}

function crc16_modbus(buffer){
    var crc = 0xFFFF;
    var odd;
    for (var i = 0; i < buffer.length; i++) {
        crc = crc ^ buffer[i];
        for (var j = 0; j < 8; j++) {
            odd = crc & 0x0001;
            crc = crc >> 1;
            if (odd) {
                crc = crc ^ 0xA001;
            }
        }
    }
    return crc;
};

window.onload = function(){
document.querySelector("input").addEventListener("change", function() {
	var reader = new FileReader();
	reader.onload = function() {
		firmwareArray = new Uint8Array(this.result).reduce(function(memo,i){return memo+("0"+i.toString(16)).slice(-2);},"");
		addLog("File was selected, size: " + firmwareArray.length/2 + " bytes");
		
        if (firmwareArray.length % 32 !== 0) {//pad last block to 16bytes
            var padHex = "ffffffffffffffffffffffffffffffff";
            firmwareArray += padHex.substr(0, 32 - firmwareArray.length % 32);
        }
		blockCount = firmwareArray.length/32;
		addLog("Count: " + blockCount);
	}
	if(this.files[0]!=null)
		reader.readAsArrayBuffer(this.files[0]);
	else
		addLog("No file selected");
}, false);
}

function updateBegin(){
	if(blockCount <= 0){
		addLog("No file selected aborting");
		return;
	}
	
	if(miEnabled)mainCharSend("1e0000",writeCharacteristicSpeed);// this makes the upload faster
	
	setTimeout(function () {	
		otaCharSend("01ff").then(function (character) {
				setTimeout(function () {
					startTime = new Date().getTime();
					sendOTAblock(0);
				}, 300);
		}).catch(function (err) {
			updateFail(err);
		});
	}, (miEnabled?500:0));
}

function sendOTAblock(blockNr){
	if (blockNr >= blockCount) {
		sendLastOTA();
		return;
	}
	setStatus("Sending block nr: " + blockNr + " from "+ blockCount + ", " + Math.floor(blockNr / (blockCount * 1.0) * 100) + "% done, time since start " + (new Date().getTime() - startTime) / 1000.0 + "s");
	var blockNrString = getHexBLockCount(blockNr);
	var blockString = blockNrString + firmwareArray.substring(blockNr * 32, blockNr * 32 + 32);
	var blockCRC = getHexCRC(blockString);
	otaCharSend(blockString + blockCRC).then(function (character) {
		setTimeout(function () {
		
          if ((blockNr + 1) % 8 == 0) {
            writeCharacteristic.readValue().then(function (result) {
				addClog('reading OTA');
				sendOTAblock(blockNr+1);
            }).catch(function (err) {
				updateFail(err);
            });
          } else {
			sendOTAblock(blockNr+1);
          }		  
		}, 50);
	}).catch(function (err) {
		updateFail(err);
    });
}

function getHexBLockCount(count){
	var tempHEX = decimalToHex(count);	
	return tempHEX.substring(2,4)+tempHEX.substring(0,2);
}

function getHexCRC(data){
	var tempCRC = decimalToHex(crc16_modbus(hexToBytes(data)));
	return tempCRC.substring(2,4)+tempCRC.substring(0,2);
}

function sendLastOTA(){
	var data = "02ff"+getHexBLockCount(blockCount-1)+getHexBLockCount(~(blockCount - 1)&0xffff);
	otaCharSend(data).then(function (character) {
		addLog("Update done");
		setStatus("Update done");
	}).catch(function (err) {
		updateFail(err);
    });
}

var otaCharSend = function(data) {
return new Promise(function(resolve, reject) {
	addClog("OTA: " + data);
	writeCharacteristic.writeValue(new Uint8Array(hexToBytes(data))).then(function (character) {
		resolve("ok");	
	}).catch(function (err) {
		reject("some error while sending char data");
    });
});
}

var mainCharSend = function(data, characteristic) {
return new Promise(function(resolve, reject) {
	addClog("Main: " + data);
	characteristic.writeValue(new Uint8Array(hexToBytes(data))).then(function (character) {
		resolve("ok");	
	}).catch(function (err) {
		reject("some error while sending char data");
    });
});
}
</script>
<big><big>Telink Flasher for Mi Thermostat</big></big><br>
Copyright: Aaron Christophel / Atc1441  https://atcnetz.de<br><br>
  <button type="button" onclick="connect();">Connect</button>
  <button type="button" onclick="reConnect();">Reconnect</button>
  <button type="button" onclick="startDFU();">Start FLashing</button>
  <button type="button" onclick="clearLog();">Clear Log</button><br><br>
Please select a .bin file you want to flash to a Telink BLE device.<br><br>
  Select Firmware: <input type="file"/><br>
 <div id="percent">Status: waiting for you to connect a device</div><hr>
 <div id="tempHumiData">Temp/Humi: waiting for data</div><hr>
 <div id="log">Log:<br></div>
 <div id="result"></div>
</body></html>